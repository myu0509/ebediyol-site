<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Ebedi Yol - A Blok</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body { margin:0; padding:0; overflow:hidden; width:100%; height:100%; background:#1a1a1a; }
  #renderCanvas { width:100%; height:100%; touch-action:none; }
  #mobileControls {
    position: fixed;
    bottom: 30px;
    right: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    z-index: 10;
  }
  .middleRow {
    display: flex;
    gap: 8px;
  }
  .ctrl {
    width: 55px;
    height: 55px;
    font-size: 24px;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.35);
    color: black;
    font-weight: bold;
    user-select: none;
    touch-action: none;
  }
</style>
</head>

<body>
<canvas id="renderCanvas"></canvas>

<!-- Mobil Kontrol -->
<div id="mobileControls">
  <button class="ctrl" id="btnUp">â–²</button>
  <div class="middleRow">
    <button class="ctrl" id="btnLeft">â—€</button>
    <button class="ctrl" id="btnRight">â–¶</button>
  </div>
  <button class="ctrl" id="btnDown">â–¼</button>
</div>

<!-- Babylon -->
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color3(0.1,0.15,0.1);

// Kamera
const camera = new BABYLON.UniversalCamera("cam", new BABYLON.Vector3(0,2,-10), scene);
camera.attachControl(canvas,true);
camera.speed = 0.4;

// IÅŸÄ±k
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene).intensity = 1.2;

/* =========================
   âœ… SESLER (DÃœZELTÄ°LMÄ°Åž)
   ========================= */

// KuÅŸ sesi (mobilde kilidi aÃ§acaÄŸÄ±z)
const birds = new BABYLON.Sound(
  "birds",
  "https://raw.githubusercontent.com/myu0509/ebediyol-site/main/sounds/birds.mp3",
  scene,
  null,
  { loop:true, autoplay:false, volume:0.3 }
);

// AdÄ±m sesi
const steps = new BABYLON.Sound(
  "steps",
  "https://raw.githubusercontent.com/myu0509/ebediyol-site/main/sounds/steps.mp3",
  scene,
  null,
  { loop:false, autoplay:false, volume:0.8 }
);

// ðŸ”“ Autoplay kilidini ilk etkileÅŸimde aÃ§ + kuÅŸ sesini baÅŸlat
const unlockAudio = () => {
  try {
    engine.getAudioContext()?.resume?.();
    BABYLON.Engine.audioEngine?.unlock?.();
  } catch(e){}
  if (!birds.isPlaying) birds.play();
  window.removeEventListener("pointerdown", unlockAudio);
  window.removeEventListener("touchstart", unlockAudio);
  window.removeEventListener("keydown", unlockAudio);
};
window.addEventListener("pointerdown", unlockAudio, { once:true });
window.addEventListener("touchstart", unlockAudio, { once:true });
window.addEventListener("keydown", unlockAudio, { once:true });

// AdÄ±m sesi iÃ§in takip deÄŸiÅŸkenleri
let lastStepPos = null;           // en son â€œadÄ±mâ€ referans pozisyonu
let stepCooldownMs = 0;           // kÃ¼Ã§Ã¼k bir aralÄ±k iÃ§in cooldown (ms)

/* ========================= */

// âœ… Avatar (Dude)
let avatar=null;
BABYLON.SceneLoader.ImportMeshAsync(
  "",
  "https://www.babylonjs.com/Scenes/Dude/",
  "Dude.babylon",
  scene
).then(res=>{
  avatar = res.meshes[0];
  avatar.scaling = new BABYLON.Vector3(0.012,0.012,0.012);
  avatar.position = new BABYLON.Vector3(0,0,-5);
});

// âœ… Zemin
const ground = BABYLON.MeshBuilder.CreateGround("g",{width:50,height:50},scene);
ground.material = new BABYLON.StandardMaterial("gm",scene);
ground.material.diffuseColor = new BABYLON.Color3(0.2,0.35,0.2);

// âœ… GÃ¶kyÃ¼zÃ¼
(function(){
  const box = BABYLON.MeshBuilder.CreateBox("sky",{size:200},scene);
  const m = new BABYLON.StandardMaterial("skyM",scene);
  m.backFaceCulling=false;
  m.disableLighting=true;
  m.reflectionTexture = new BABYLON.CubeTexture("https://playground.babylonjs.com/textures/skybox",scene);
  m.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
  box.material = m;
})();

// âœ… Mezar Sistemi
const graveMat = new BABYLON.StandardMaterial("gm2",scene);
graveMat.diffuseColor = new BABYLON.Color3(0.65,0.65,0.65);

const rows=10, cols=10;
const spacing=5;
const startX = -((cols-1)*spacing)/2;
const startZ = ((rows-1)*spacing)/2;

for(let r=0;r<rows;r++){
  for(let c=0;c<cols;c++){
    const gx = startX + c*spacing;
    const gz = startZ - r*spacing;

    let stone = BABYLON.MeshBuilder.CreateBox("stone",{width:0.8,height:1.2,depth:0.2},scene);
    stone.position.set(gx,0.6,gz);
    stone.material=graveMat;

    let mound = BABYLON.MeshBuilder.CreateCylinder("m",{
      diameterTop:1, diameterBottom:1.8, height:0.2
    },scene);
    mound.position.set(gx,0.1,gz+0.5);
    mound.scaling.z=2;
    let mm = new BABYLON.StandardMaterial("mmm",scene);
    mm.diffuseColor=new BABYLON.Color3(0.3,0.2,0.1);
    mound.material=mm;
  }
}

// âœ… Ã‡itler
function makeFence(x,z,rot){
  let f = BABYLON.MeshBuilder.CreateBox("f",{width:5,height:1,depth:0.2},scene);
  f.position.set(x,0.5,z);
  f.rotation.y=rot;
  let fm=new BABYLON.StandardMaterial("fm",scene);
  fm.diffuseColor=new BABYLON.Color3(0.3,0.2,0.1);
  f.material=fm;
}
for(let i=-25;i<=25;i+=5){
  makeFence(i,-25,0);
  makeFence(i,25,0);
}
for(let i=-25;i<=25;i+=5){
  makeFence(-25,i,Math.PI/2);
  makeFence(25,i,Math.PI/2);
}

// âœ… Mobil yÃ¶n deÄŸiÅŸkenleri
let fwd=false, back=false, left=false, right=false;

document.getElementById("btnUp").ontouchstart = ()=>fwd=true;
document.getElementById("btnUp").ontouchend   = ()=>fwd=false;
document.getElementById("btnDown").ontouchstart=()=>back=true;
document.getElementById("btnDown").ontouchend  =()=>back=false;
document.getElementById("btnLeft").ontouchstart=()=>left=true;
document.getElementById("btnLeft").ontouchend  =()=>left=false;
document.getElementById("btnRight").ontouchstart=()=>right=true;
document.getElementById("btnRight").ontouchend  =()=>right=false;

// âœ… Klavye
window.addEventListener("keydown",e=>{
  if(e.key==="w"||e.key==="ArrowUp")fwd=true;
  if(e.key==="s"||e.key==="ArrowDown")back=true;
  if(e.key==="a"||e.key==="ArrowLeft")left=true;
  if(e.key==="d"||e.key==="ArrowRight")right=true;
});
window.addEventListener("keyup",e=>{
  if(e.key==="w"||e.key==="ArrowUp")fwd=false;
  if(e.key==="s"||e.key==="ArrowDown")back=false;
  if(e.key==="a"||e.key==="ArrowLeft")left=false;
  if(e.key==="d"||e.key==="ArrowRight")right=false;
});

// âœ… Loop
scene.onBeforeRenderObservable.add(()=>{
  if(!avatar) return;

  const dt = engine.getDeltaTime();               // ms
  if (stepCooldownMs > 0) stepCooldownMs -= dt;

  let sp=0.1;

  // Hareket
  if(fwd){
    avatar.position.z+= sp*Math.cos(camera.rotation.y);
    avatar.position.x+= sp*Math.sin(camera.rotation.y);
  }
  if(back){
    avatar.position.z-= sp*Math.cos(camera.rotation.y);
    avatar.position.x-= sp*Math.sin(camera.rotation.y);
  }
  if(left) camera.rotation.y-=0.04;
  if(right) camera.rotation.y+=0.04;

  // Kamera avatarÄ± takip etsin
  camera.position.x = avatar.position.x - 4*Math.sin(camera.rotation.y);
  camera.position.z = avatar.position.z - 4*Math.cos(camera.rotation.y);
  camera.position.y = avatar.position.y + 1.8;

  // âœ… AdÄ±m sesi â€” SADECE yÃ¼rÃ¼rken
  const walking = (fwd || back);
  if (walking) {
    if (!lastStepPos) lastStepPos = avatar.position.clone();
    const dist = BABYLON.Vector3.Distance(avatar.position, lastStepPos);

    // adÄ±m uzunluÄŸu (metre) + kÃ¼Ã§Ã¼k cooldown ile â€œdurunca sonradan Ã§almaâ€ engellenir
    const STEP_STRIDE = 0.85;

    if (dist >= STEP_STRIDE && stepCooldownMs <= 0) {
      try {
        steps.stop();          // overlap riskini sÄ±fÄ±rla
        steps.play();
      } catch(e){}
      lastStepPos = avatar.position.clone();
      stepCooldownMs = 120;    // 120 msâ€™lik kÃ¼Ã§Ã¼k tampon
    }
  } else {
    // durunca anÄ±nda kes
    if (steps.isPlaying) steps.stop();
    lastStepPos = null;
    stepCooldownMs = 0;
  }
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
